"use strict";(self.webpackChunkdts_hytera=self.webpackChunkdts_hytera||[]).push([[774],{3534:(t,e,o)=>{o.d(e,{Z:()=>s});var n=o(5893),i=o(7294),r=o(4880);const a=o(6158);a.accessToken=r.c3;const s=({dragRotate:t,map:e,pitch:o,bearing:r,mapContainer:s,lng:l,lat:c,zoom:d,setLng:u,setLat:p,setZoom:g,setLoad:y,style:f})=>((0,i.useEffect)((()=>{console.log("map.current",e.current,r),e.current||(s&&(e.current=new a.Map({container:s.current,style:f,center:[l,c],pitch:o,bearing:r,zoom:d,maxBounds:[[-78.2747922,-7.6626779],[-78.1305246,-7.5534415]],antialias:!0,dragRotate:t})),console.log("inianco"))}),[e,s]),(0,i.useEffect)((()=>{e.current&&(e.current.addControl(new a.FullscreenControl,"bottom-left"),e.current.addControl(new a.NavigationControl,"bottom-left"),e.current.on("move",(()=>{e.current&&g(e.current.getZoom().toFixed(2))})),e.current.on("load",(()=>{y(!0)})))}),[e]),(0,i.useEffect)((()=>{e.current&&e.current.setBearing(r)}),[r]),(0,n.jsx)("div",{ref:s,style:{flex:1,height:"100vh",width:"100%"},className:"map-container"},void 0))},3774:(t,e,o)=>{o.r(e),o.d(e,{default:()=>x});var n,i=o(5893),r=o(7294),a=o(3534),s=o(4880);!function(t){t.truck="truck",t.excavator="excavator"}(n||(n={}));const l=t=>t<=0||t<s.X9?0:t-s.X9,c=({load:t,tb:e,stream:o,model:a})=>{const[c,d]=(0,r.useState)([]);return(0,r.useEffect)((()=>{if(o){const t=!!o&&!o.deviceAlias.includes("EX-");console.log("isTruck",t,o.deviceAlias);const i=c.findIndex((t=>t.id===o.deviceId)),r=`${s.$e}/public/obj/gltf/${t?"truck":"excavator"}.gltf`;if(-1===i){let i=null;i=t?a.truck?a.truck:null:a.excavator?a.excavator:null;const{sensor:s}=o;if(i&&s&&s.longitude&&s.latitude){const a=i.duplicate(),u={id:o.deviceId,model:a,unit:o,origin:[s.longitude,s.latitude,l(s.altitude)],path:r,type:t?n.truck:n.excavator};d((t=>-1===t.findIndex((t=>t.id===u.id))?(e.add(a),[...c,u]):t))}}}}),[o,t,e,a]),(0,r.useEffect)((()=>{if(o){const t=c.find((t=>t.id===o.deviceId));if(t){console.log("unitFind",c,o);const{sensor:e}=o;t.model.setRotation({z:-e.direction}),t.model.setCoords([e.longitude,e.latitude,l(e.altitude)])}}}),[c,o]),(0,i.jsx)(i.Fragment,{},void 0)};var d=o(7348);const u=({map:t,polygons:e,polygons_actives:o,loadMap:n})=>((0,r.useEffect)((()=>{if(t&&n&&e.length>0){const n=(0,d.wf)(e),i=(0,d.wf)(o);t.addSource("polygons_3d_source",{type:"geojson",data:n}),t.addSource("polygons_actives_3d_source",{type:"geojson",data:i}),t.addLayer({id:"polygons_actives_3d_layer",type:"fill-extrusion",source:"polygons_actives_3d_source",paint:{"fill-extrusion-color":{type:"identity",property:"color"},"fill-extrusion-height":{type:"identity",property:"height"},"fill-extrusion-opacity":1,"fill-extrusion-base":{type:"identity",property:"base_height"},"fill-extrusion-height-transition":{duration:1e4,delay:0},"fill-extrusion-vertical-gradient":!1}}),t.addLayer({id:"polygons_actives_base_3d",type:"fill-extrusion",filter:["has","height"],source:"polygons_actives_3d_source",paint:{"fill-extrusion-color":"rgb(189,94,0)","fill-extrusion-height":["get","height_proyection"],"fill-extrusion-opacity":.2,"fill-extrusion-vertical-gradient":!1}}),t.addLayer({id:"polygons_3d_layer",type:"fill-extrusion",source:"polygons_3d_source",paint:{"fill-extrusion-color":{type:"identity",property:"color"},"fill-extrusion-height":{type:"identity",property:"height"},"fill-extrusion-opacity":.2,"fill-extrusion-base":{type:"identity",property:"base_height"},"fill-extrusion-height-transition":{duration:1e4,delay:0},"fill-extrusion-vertical-gradient":!1}}),t.addLayer({id:"polygons_base_3d",type:"fill-extrusion",filter:["has","height"],source:"polygons_3d_source",paint:{"fill-extrusion-color":"rgb(189,94,0)","fill-extrusion-height":["get","height_proyection"],"fill-extrusion-opacity":.05,"fill-extrusion-vertical-gradient":!1}})}}),[t,e,n]),(0,i.jsx)(i.Fragment,{},void 0)),p=({map:t,id:e,color:o,points:n,opacity:a,loadMap:s,level:l,heigth:c,fromBase:u})=>((0,r.useEffect)((()=>{t&&s&&(t.addSource(e+"",{type:"geojson",data:(0,d.ET)(n,l,c,o,u)}),t.addLayer({id:e+"",type:"fill-extrusion",filter:["has","height"],source:e,paint:{"fill-extrusion-color":{type:"identity",property:"color"},"fill-extrusion-height":{type:"identity",property:"height"},"fill-extrusion-opacity":a,"fill-extrusion-base":{type:"identity",property:"base_height"},"fill-extrusion-vertical-gradient":!0}}))}),[t,s]),(0,i.jsx)(i.Fragment,{},void 0));let g=[];const y=({benchs:t,routes:e,polygons:o,streamTruck:n,streamExcavator:l,polygons_actives:d})=>{const y=(0,r.useRef)(null),f=(0,r.useRef)(null),[h,x]=(0,r.useState)(-78.2045567035675),[v,m]=(0,r.useState)(-7.617878602920846),[b,w]=(0,r.useState)(15),[_,j]=(0,r.useState)(),[k,E]=(0,r.useState)(!1),[L,C]=(0,r.useState)({truck:null,excavator:null});return(0,r.useEffect)((()=>{if(k&&!f.current.getLayer("objects3D")&&!_){console.log("cargandoLAYRER"),window.tb=new window.Threebox(f.current,f.current.getCanvas().getContext("webgl"),{defaultLights:!0});const t=new window.THREE.DirectionalLight("#000",1,100);t.position.set(0,0,100).normalize(),t.castShadow=!0,j(window.tb),f.current.addLayer({id:"objects3D",type:"custom",renderingMode:"3d",onAdd:function(t,e){return o=this,n=void 0,r=function*(){const t={obj:`${s.$e}/public/obj/gltf/truck02.gltf`,type:"gltf",scale:2,units:"meters",anchor:"center",adjustment:{x:0,y:0,z:0},rotation:{x:90,y:-90,z:0}},e={obj:`${s.$e}/public/obj/gltf/excavator.gltf`,type:"gltf",scale:2.5,units:"meters",anchor:"center",adjustment:{x:0,y:0,z:0},rotation:{x:90,y:80,z:0}};window.tb.loadObj(t,(function(t){window.tb.loadObj(e,(function(e){console.log("objTruck",t,e),C({truck:t,excavator:e})}))}))},new((i=void 0)||(i=Promise))((function(t,e){function a(t){try{l(r.next(t))}catch(t){e(t)}}function s(t){try{l(r.throw(t))}catch(t){e(t)}}function l(e){var o;e.done?t(e.value):(o=e.value,o instanceof i?o:new i((function(t){t(o)}))).then(a,s)}l((r=r.apply(o,n||[])).next())}));var o,n,i,r},render:function(t,e){window.tb.update()}})}}),[k,_]),(0,r.useEffect)((()=>{f.current&&_&&e.length>0&&(e.map((t=>{const e=_.line({width:12,color:t.color,opacity:1,geometry:t.points});window.tb.add(e),console.log("lineMesh",t),g.push(e)})),console.log("Entrando",g))}),[f,e,_]),(0,r.useEffect)((()=>{let t=0;t=b>13&&b<14?b/3:b>=14&&b<15?b/2:b>=15&&b<16?b:b>=16&&b<17?3*b:4*b,g.length>0&&g.length===e.length&&(console.log("actualizando"),g.forEach((t=>{window.tb.remove(t)})),g=[],t=Math.pow(2,b-12),e.map((e=>{const o=window.tb.line({width:t,color:e.color,opacity:1,geometry:e.points});window.tb.add(o),g.push(o)}))),console.log("<oom",b,t)}),[b]),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.Z,Object.assign({map:f,dragRotate:!0,style:"mapbox://styles/dispatchgat/ckqqsfc2y46bo17sf1y29zwnj",mapContainer:y,bearing:0,pitch:25},{lat:v,lng:h,zoom:b,setLat:m,setLng:x,setZoom:w,setLoad:E}),void 0),(0,i.jsx)(u,{map:f.current,polygons:o,polygons_actives:d,loadMap:k},void 0),e.map(((t,e)=>(0,i.jsx)(r.Fragment,{children:t.points&&t.points.length>0&&(0,i.jsx)(p,{points:t.points,color:t.color,id:`base_route${e}`,loadMap:k,map:f.current,opacity:.1,level:0,fromBase:!0,heigth:t.points[0][2]-s.X9-10},void 0)},e))),L.truck&&(0,i.jsx)(c,{keyLayer:"layerTrucks",map:f.current,load:k,scale:.5,tb:window.tb,stream:n,model:L},void 0),L.truck&&(0,i.jsx)(c,{keyLayer:"layerExcavator",map:f.current,load:k,scale:.5,tb:window.tb,stream:l,model:L},void 0)]},void 0)};var f=o(3513);const h=()=>(0,i.jsx)("div",Object.assign({style:{display:"flex",justifyContent:"space-between",height:"100vh"}},{children:(0,i.jsx)(f.a.Consumer,{children:t=>{const{streamTruck:e,streamExcavator:o,benchs:n,polygons:r,polygons_actives:a,routes:s}=t;return(0,i.jsx)(y,{benchs:n,routes:s,polygons:r,polygons_actives:a,streamExcavator:o,streamTruck:e},void 0)}},void 0)}),void 0),x=()=>(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(h,{},void 0)},void 0)}}]);